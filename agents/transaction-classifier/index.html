<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Classifier Agent | Basis Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Oxygen:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --basis-teal: #41666F;
            --basis-teal-light: #5a8a95;
            --basis-teal-dark: #254951;
            --bg-primary: #121518;
            --bg-secondary: #1a1d21;
            --bg-tertiary: #22262b;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --text-muted: #6b7280;
            --border-color: #2d3238;
            --success: #4ade80;
            --warning: #fbbf24;
            --info: #60a5fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Oxygen', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header h1 span {
            color: var(--basis-teal-light);
        }

        .back-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--basis-teal-light);
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .intro {
            margin-bottom: 2rem;
        }

        .intro h2 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .intro p {
            color: var(--text-secondary);
            max-width: 700px;
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* Panels */
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .panel-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--basis-teal-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--basis-teal-light);
            background: rgba(90, 138, 149, 0.1);
        }

        .upload-area svg {
            width: 48px;
            height: 48px;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .upload-area p {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .upload-area span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        #file-input {
            display: none;
        }

        /* Sample Data Buttons */
        .sample-data {
            margin-top: 1rem;
        }

        .sample-data p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .sample-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .btn:hover {
            border-color: var(--basis-teal-light);
            background: var(--bg-secondary);
        }

        .btn-primary {
            background: var(--basis-teal);
            border-color: var(--basis-teal);
        }

        .btn-primary:hover {
            background: var(--basis-teal-light);
            border-color: var(--basis-teal-light);
        }

        .btn small {
            display: block;
            color: var(--text-muted);
            font-weight: 400;
            margin-top: 0.25rem;
        }

        /* OpenAI Config */
        .config-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .config-section label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .config-section input {
            width: 100%;
            padding: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
        }

        .config-section input:focus {
            outline: none;
            border-color: var(--basis-teal-light);
        }

        .config-section .hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Results Panel */
        .results-panel {
            min-height: 500px;
        }

        .results-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-muted);
            text-align: center;
        }

        .results-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Stats Bar */
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .stat {
            background: var(--bg-tertiary);
            padding: 1rem 1.5rem;
            border-radius: 6px;
            min-width: 140px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.info { color: var(--info); }

        /* Results Table */
        .results-table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .results-table th {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
        }

        .results-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .results-table tr:hover {
            background: rgba(90, 138, 149, 0.05);
        }

        .description-cell {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .amount-cell {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }

        .amount-positive { color: var(--success); }
        .amount-negative { color: var(--text-primary); }

        .category-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .confidence-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .confidence-high { background: var(--success); }
        .confidence-medium { background: var(--warning); }
        .confidence-low { background: #ef4444; }

        .method-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            background: var(--bg-primary);
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .method-badge.llm {
            background: rgba(96, 165, 250, 0.2);
            color: var(--info);
        }

        /* Engine Selector */
        .engine-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .engine-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .engine-btn:hover {
            border-color: var(--basis-teal-light);
            color: var(--text-primary);
        }

        .engine-btn.active {
            background: var(--basis-teal-dark);
            border-color: var(--basis-teal);
            color: var(--text-primary);
        }

        .engine-icon {
            font-size: 1.1rem;
        }

        /* Ollama Config */
        .ollama-config {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .ollama-config label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .model-select {
            width: 100%;
            padding: 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .model-select:focus {
            outline: none;
            border-color: var(--basis-teal-light);
        }

        .ollama-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }

        .status-dot.connected {
            background: var(--success);
        }

        .status-dot.disconnected {
            background: #ef4444;
        }

        .status-text {
            color: var(--text-muted);
        }

        /* OpenAI Config */
        .openai-config {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .openai-config label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .api-key-input {
            width: 100%;
            padding: 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--basis-teal-light);
        }

        /* Hybrid Config */
        .hybrid-config {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .hybrid-config label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .hybrid-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Eval Section */
        .eval-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .eval-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px dashed var(--border-color);
        }

        .eval-btn:hover {
            border-style: solid;
            border-color: var(--basis-teal-light);
        }

        /* Eval Results */
        .eval-results {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .eval-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .eval-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .eval-accuracy {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .eval-accuracy.good { color: var(--success); }
        .eval-accuracy.medium { color: var(--warning); }
        .eval-accuracy.bad { color: #ef4444; }

        .eval-breakdown {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .eval-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .eval-row:last-child {
            border-bottom: none;
        }

        .eval-category {
            color: var(--text-secondary);
        }

        .eval-score {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
        }

        .eval-score.correct { color: var(--success); }
        .eval-score.incorrect { color: #ef4444; }

        .eval-meta {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Export Button */
        .export-section {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Footer */
        .footer {
            margin-top: 3rem;
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .footer a {
            color: var(--basis-teal-light);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--basis-teal-light);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           MOBILE RESPONSIVE STYLES
           ============================================ */

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .container {
                padding: 1rem;
            }

            .intro h2 {
                font-size: 1.1rem;
            }

            .intro p {
                font-size: 0.9rem;
            }

            .panel {
                padding: 1rem;
            }

            .upload-area {
                padding: 1.5rem 1rem;
            }

            .upload-area svg {
                width: 36px;
                height: 36px;
            }

            .stats-bar {
                gap: 0.75rem;
            }

            .stat {
                padding: 0.75rem 1rem;
                min-width: 100px;
                flex: 1;
            }

            .stat-value {
                font-size: 1.25rem;
            }

            .results-table th,
            .results-table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .description-cell {
                max-width: 120px;
                font-size: 0.7rem;
            }

            .category-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.5rem;
            }

            .btn {
                font-size: 0.75rem;
                padding: 0.6rem 0.8rem;
            }

            .export-section {
                flex-direction: column;
            }

            .footer {
                padding: 1rem;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1rem;
            }

            .back-link {
                font-size: 0.8rem;
            }

            .stats-bar {
                flex-direction: column;
            }

            .stat {
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .stat-value {
                order: 2;
            }

            .stat-label {
                order: 1;
            }

            .results-table-container {
                max-height: 350px;
            }

            .config-section input {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1><span>//</span> Transaction Classifier Agent</h1>
            <a href="../../index.html" class="back-link">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Target Map
            </a>
        </div>
    </header>

    <main class="container">
        <div class="intro">
            <h2>Automatic Transaction Classification</h2>
            <p>Upload a CSV of bank transactions and this agent will automatically categorize each one into the appropriate accounting category. Uses rule-based matching for common patterns, with optional LLM fallback for ambiguous transactions.</p>
        </div>

        <div class="grid">
            <!-- Left Panel: Upload & Config -->
            <div class="left-column">
                <div class="panel">
                    <div class="panel-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload Transactions
                    </div>

                    <div class="upload-area" id="upload-area">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p>Drag & drop your CSV file here</p>
                        <span>or click to browse</span>
                        <input type="file" id="file-input" accept=".csv">
                    </div>

                    <div class="sample-data">
                        <p>Or try with sample data:</p>
                        <div class="sample-buttons">
                            <button class="btn" id="load-small-business">
                                Small Business Transactions
                                <small>50 transactions: revenue, payroll, software, travel</small>
                            </button>
                            <button class="btn" id="load-accounting-firm">
                                Accounting Firm Transactions
                                <small>50 transactions: client fees, CPE, tax software</small>
                            </button>
                        </div>
                    </div>

                    <div class="config-section">
                        <label>Classification Engine</label>
                        <div class="engine-selector">
                            <button class="engine-btn active" data-engine="rules" onclick="setEngine('rules')">
                                <span class="engine-icon">âš¡</span>
                                <span>Rules</span>
                            </button>
                            <button class="engine-btn" data-engine="hybrid" onclick="setEngine('hybrid')">
                                <span class="engine-icon">ðŸ”€</span>
                                <span>Hybrid</span>
                            </button>
                            <button class="engine-btn" data-engine="ollama" onclick="setEngine('ollama')">
                                <span class="engine-icon">ðŸ¦™</span>
                                <span>Ollama</span>
                            </button>
                            <button class="engine-btn" data-engine="openai" onclick="setEngine('openai')">
                                <span class="engine-icon">ðŸ¤–</span>
                                <span>OpenAI</span>
                            </button>
                        </div>

                        <div class="ollama-config" id="ollama-config" style="display: none;">
                            <label for="ollama-model">Model</label>
                            <select id="ollama-model" class="model-select">
                                <option value="llama3.2">Llama 3.2 (3B)</option>
                                <option value="llama3.2:7b">Llama 3.2 (7B)</option>
                                <option value="mistral">Mistral (7B)</option>
                                <option value="phi3">Phi-3 (3.8B)</option>
                            </select>
                            <p class="hint">Requires Ollama running locally on port 11434</p>
                            <div class="ollama-status" id="ollama-status">
                                <span class="status-dot"></span>
                                <span class="status-text">Checking connection...</span>
                            </div>
                        </div>

                        <div class="openai-config" id="openai-config" style="display: none;">
                            <label for="openai-key">API Key</label>
                            <input type="password" id="openai-key" class="api-key-input" placeholder="sk-...">
                            <label for="openai-model" style="margin-top: 0.75rem;">Model</label>
                            <select id="openai-model" class="model-select">
                                <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
                                <option value="gpt-4o">GPT-4o (Best)</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Legacy)</option>
                            </select>
                            <p class="hint">Works when deployed - no local setup needed</p>
                        </div>

                        <div class="hybrid-config" id="hybrid-config" style="display: none;">
                            <p class="hybrid-desc">Rules first, then LLM for ambiguous transactions</p>
                            <label for="hybrid-fallback">Fallback LLM</label>
                            <select id="hybrid-fallback" class="model-select">
                                <option value="openai">OpenAI</option>
                                <option value="ollama">Ollama (Local)</option>
                            </select>
                            <div class="hybrid-openai-key" id="hybrid-openai-key">
                                <label for="hybrid-api-key" style="margin-top: 0.75rem;">OpenAI API Key</label>
                                <input type="password" id="hybrid-api-key" class="api-key-input" placeholder="sk-...">
                            </div>
                            <p class="hint">Only calls LLM for low-confidence classifications</p>
                        </div>
                    </div>

                    <div class="eval-section">
                        <button class="btn eval-btn" onclick="runEvalSuite()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 12l2 2 4-4"/>
                                <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Run Eval Suite
                        </button>
                        <p class="hint">Test accuracy against labeled dataset</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Results -->
            <div class="results-panel panel">
                <div class="panel-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Classification Results
                </div>

                <div id="results-container">
                    <div class="results-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p>Upload a CSV file to see classifications</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>Part of the <a href="../../index.html">Basis Deployed Intelligence</a> application for Jake McCorkle</p>
    </footer>

    <script>
        // ===========================================
        // CLASSIFICATION RULES ENGINE
        // ===========================================

        const CLASSIFICATION_RULES = {
            // Revenue categories
            'Revenue': {
                keywords: ['STRIPE TRANSFER', 'STRIPE PAYOUT', 'SQUARE TRANSFER', 'PAYPAL TRANSFER',
                          'CHECK DEP', 'WIRE TRANSFER IN', 'CLIENT PMT', 'CLIENT RETAINER',
                          'INVOICE', 'CONSULTING FEE', 'ADVISORY FEE', 'CLIO PAYMENTS'],
                amountDirection: 'positive'
            },

            // Payroll
            'Payroll': {
                keywords: ['GUSTO', 'ADP PAYROLL', 'PAYCHEX', 'PAYROLL'],
                excludeKeywords: ['TAX'],
                amountDirection: 'negative'
            },
            'Payroll Tax': {
                keywords: ['PAYROLL TAX', 'TAX DEPOSIT', 'GUSTO PAYROLL TAX', 'ADP PAYROLL TAX'],
                amountDirection: 'negative'
            },

            // Software & Subscriptions
            'Software - Productivity': {
                keywords: ['GOOGLE *WORKSPACE', 'MICROSOFT 365', 'SLACK', 'ZOOM', 'NOTION',
                          'CALENDLY', 'ASANA', 'TRELLO', 'FIGMA', 'CANVA', 'ADOBE'],
                amountDirection: 'negative'
            },
            'Software - Accounting': {
                keywords: ['QUICKBOOKS', 'XERO', 'FRESHBOOKS', 'WAVE', 'SAGE',
                          'THOMSON REUTERS', 'CCH', 'LACERTE', 'PROCONNECT', 'INTUIT',
                          'DEXT', 'RECEIPT BANK', 'KARBON', 'PRACTICE CS', 'SAFESEND', 'SHAREFILE'],
                amountDirection: 'negative'
            },
            'Software - Development': {
                keywords: ['GITHUB', 'GITLAB', 'AWS', 'HEROKU', 'DIGITALOCEAN', 'AZURE'],
                amountDirection: 'negative'
            },
            'Software - Marketing': {
                keywords: ['HUBSPOT', 'MAILCHIMP', 'LINKEDIN PREMIUM', 'HOOTSUITE', 'BUFFER'],
                amountDirection: 'negative'
            },

            // Travel & Entertainment
            'Travel - Transportation': {
                keywords: ['UBER TRIP', 'LYFT', 'DELTA AIR', 'UNITED AIR', 'AMERICAN AIR',
                          'SOUTHWEST', 'JETBLUE', 'AMTRAK', 'ENTERPRISE RENT'],
                amountDirection: 'negative'
            },
            'Travel - Lodging': {
                keywords: ['MARRIOTT', 'HILTON', 'HYATT', 'IHG', 'AIRBNB', 'HOTEL', 'VRBO'],
                amountDirection: 'negative'
            },
            'Meals': {
                keywords: ['UBER EATS', 'DOORDASH', 'GRUBHUB', 'POSTMATES', 'STARBUCKS',
                          'RESTAURANT', 'CAFE', 'DINER'],
                amountDirection: 'negative'
            },

            // Office & Operations
            'Office Supplies': {
                keywords: ['STAPLES', 'OFFICE DEPOT', 'OFFICEMAX', 'AMAZON', 'AMZN MKTP'],
                amountDirection: 'negative'
            },
            'Shipping': {
                keywords: ['FEDEX', 'UPS', 'USPS', 'DHL'],
                amountDirection: 'negative'
            },

            // Facilities
            'Rent': {
                keywords: ['RENT', 'BUILDING RENT', 'OFFICE RENT', 'LEASE'],
                amountDirection: 'negative'
            },
            'Utilities': {
                keywords: ['PG&E', 'ELECTRIC', 'GAS', 'WATER', 'COMCAST', 'VERIZON',
                          'AT&T', 'T-MOBILE', 'SPECTRUM', 'INTERNET'],
                amountDirection: 'negative'
            },

            // Insurance
            'Insurance': {
                keywords: ['STATE FARM', 'GEICO', 'ALLSTATE', 'INSURANCE', 'CAMICO', 'E&O'],
                amountDirection: 'negative'
            },

            // Professional Development (especially for accounting firms)
            'Professional Development': {
                keywords: ['CPE', 'BECKER', 'AICPA', 'CPA SOCIETY', 'WEBINAR', 'CONFERENCE',
                          'SEMINAR', 'TRAINING', 'MEMBERSHIP DUES'],
                amountDirection: 'negative'
            },

            // Banking
            'Bank Fees': {
                keywords: ['SERVICE FEE', 'BANK FEE', 'ANALYSIS FEE', 'WIRE FEE', 'MAINTENANCE FEE'],
                amountDirection: 'negative'
            },
            'Interest Income': {
                keywords: ['INTEREST EARNED', 'INTEREST INCOME', 'INT EARNED'],
                amountDirection: 'positive'
            },

            // Transfers (not expense)
            'Transfer': {
                keywords: ['TRANSFER TO SAVINGS', 'TRANSFER TO CHECKING', 'XFER', 'TFR'],
                amountDirection: 'any'
            },

            // Wholesale/Inventory
            'Cost of Goods': {
                keywords: ['COSTCO WHSE', 'WHOLESALE', 'INVENTORY'],
                amountDirection: 'negative'
            },

            // Refunds
            'Refund': {
                keywords: ['REFUND', 'OVERPAYMENT'],
                amountDirection: 'any'
            }
        };

        // ===========================================
        // CLASSIFIER ENGINE
        // ===========================================

        function classifyTransaction(transaction) {
            const description = transaction.description.toUpperCase();
            const amount = parseFloat(transaction.amount.replace(/[âˆ’\-\$,]/g, '-').replace('--', '-'));
            const isPositive = amount >= 0;

            let bestMatch = null;
            let bestScore = 0;

            for (const [category, rules] of Object.entries(CLASSIFICATION_RULES)) {
                let score = 0;

                // Check if any keyword matches
                const keywordMatch = rules.keywords.some(kw => description.includes(kw.toUpperCase()));
                if (!keywordMatch) continue;

                // Check exclude keywords
                if (rules.excludeKeywords) {
                    const excluded = rules.excludeKeywords.some(kw => description.includes(kw.toUpperCase()));
                    if (excluded) continue;
                }

                // Check amount direction
                if (rules.amountDirection !== 'any') {
                    const directionMatches = (rules.amountDirection === 'positive' && isPositive) ||
                                            (rules.amountDirection === 'negative' && !isPositive);
                    if (!directionMatches) continue;
                }

                // Calculate match score based on keyword specificity
                const matchedKeyword = rules.keywords.find(kw => description.includes(kw.toUpperCase()));
                score = matchedKeyword ? matchedKeyword.length : 0;

                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = category;
                }
            }

            if (bestMatch) {
                return {
                    category: bestMatch,
                    confidence: bestScore > 10 ? 'high' : bestScore > 5 ? 'medium' : 'low',
                    method: 'rules'
                };
            }

            return {
                category: 'Uncategorized',
                confidence: 'low',
                method: 'none',
                needsReview: true
            };
        }

        // ===========================================
        // ENGINE STATE
        // ===========================================
        let currentEngine = 'rules';
        let ollamaConnected = false;

        function setEngine(engine) {
            currentEngine = engine;

            // Update UI
            document.querySelectorAll('.engine-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.engine === engine);
            });

            // Show/hide config panels
            document.getElementById('ollama-config').style.display = engine === 'ollama' ? 'block' : 'none';
            document.getElementById('openai-config').style.display = engine === 'openai' ? 'block' : 'none';
            document.getElementById('hybrid-config').style.display = engine === 'hybrid' ? 'block' : 'none';

            // Check Ollama connection when selected
            if (engine === 'ollama') {
                checkOllamaConnection();
            }

            // Check Ollama for hybrid mode if selected
            if (engine === 'hybrid') {
                updateHybridFallbackUI();
            }
        }

        function updateHybridFallbackUI() {
            const fallback = document.getElementById('hybrid-fallback').value;
            document.getElementById('hybrid-openai-key').style.display = fallback === 'openai' ? 'block' : 'none';

            if (fallback === 'ollama') {
                checkOllamaConnection();
            }
        }

        // Hybrid fallback toggle listener
        document.addEventListener('DOMContentLoaded', () => {
            const hybridFallback = document.getElementById('hybrid-fallback');
            if (hybridFallback) {
                hybridFallback.addEventListener('change', updateHybridFallbackUI);
            }
        });

        async function checkOllamaConnection() {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.querySelector('.status-text');

            statusDot.className = 'status-dot';
            statusText.textContent = 'Checking connection...';

            try {
                const response = await fetch('http://localhost:11434/api/tags');
                if (response.ok) {
                    const data = await response.json();
                    ollamaConnected = true;
                    statusDot.classList.add('connected');
                    statusText.textContent = `Connected (${data.models?.length || 0} models available)`;
                } else {
                    throw new Error('Not connected');
                }
            } catch (error) {
                ollamaConnected = false;
                statusDot.classList.add('disconnected');
                statusText.textContent = 'Not connected - run "ollama serve"';
            }
        }

        // ===========================================
        // OLLAMA CLASSIFICATION
        // ===========================================

        async function classifyWithOllama(transaction) {
            const model = document.getElementById('ollama-model').value;
            const categories = Object.keys(CLASSIFICATION_RULES).join(', ');

            const prompt = `You are a bookkeeping assistant classifying bank transactions for a small business.

Available categories: ${categories}

Classify this transaction:
Description: ${transaction.description}
Amount: ${transaction.amount}

Respond with ONLY the category name from the list above, nothing else.`;

            try {
                const response = await fetch('http://localhost:11434/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: model,
                        prompt: prompt,
                        stream: false,
                        options: {
                            temperature: 0,
                            num_predict: 50
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Ollama request failed');
                }

                const data = await response.json();
                let category = data.response.trim();

                // Clean up the response - extract just the category name
                category = category.split('\n')[0].trim();
                category = category.replace(/^["']|["']$/g, '');

                // Validate against known categories
                const validCategories = Object.keys(CLASSIFICATION_RULES);
                const matchedCategory = validCategories.find(c =>
                    category.toLowerCase().includes(c.toLowerCase()) ||
                    c.toLowerCase().includes(category.toLowerCase())
                );

                return {
                    category: matchedCategory || category,
                    confidence: matchedCategory ? 'high' : 'medium',
                    method: 'llm'
                };
            } catch (error) {
                console.error('Ollama classification failed:', error);
                return {
                    category: 'Uncategorized',
                    confidence: 'low',
                    method: 'error',
                    needsReview: true
                };
            }
        }

        // ===========================================
        // EVAL SUITE
        // ===========================================

        const EVAL_TEST_SET = [
            { description: 'STRIPE TRANSFER 240102', amount: '4250.00', expected: 'Revenue' },
            { description: 'GUSTO PAYROLL', amount: '-3200.00', expected: 'Payroll' },
            { description: 'GUSTO PAYROLL TAX', amount: '-485.00', expected: 'Payroll Tax' },
            { description: 'AMZN MKTP US*2K4X7', amount: '-89.99', expected: 'Office Supplies' },
            { description: 'GOOGLE *WORKSPACE', amount: '-72.00', expected: 'Software - Productivity' },
            { description: 'UBER TRIP 01/07', amount: '-34.50', expected: 'Travel - Transportation' },
            { description: 'COMCAST BUSINESS', amount: '-199.00', expected: 'Utilities' },
            { description: 'SLACK TECHNOLOGIES', amount: '-15.00', expected: 'Software - Productivity' },
            { description: 'STAPLES DIRECT', amount: '-156.78', expected: 'Office Supplies' },
            { description: 'ZOOM.US', amount: '-149.90', expected: 'Software - Productivity' },
            { description: 'ADOBE *CREATIVE CLOUD', amount: '-59.99', expected: 'Software - Productivity' },
            { description: 'DELTA AIR 0062341987', amount: '-387.00', expected: 'Travel - Transportation' },
            { description: 'MARRIOTT CHICAGO', amount: '-289.00', expected: 'Travel - Lodging' },
            { description: 'UBER EATS', amount: '-42.15', expected: 'Meals' },
            { description: 'AWS SERVICES', amount: '-234.67', expected: 'Software - Development' },
            { description: 'LINKEDIN PREMIUM', amount: '-59.99', expected: 'Software - Marketing' },
            { description: 'PG&E ELECTRIC', amount: '-342.00', expected: 'Utilities' },
            { description: 'QUICKBOOKS SUBSCRIPTION', amount: '-85.00', expected: 'Software - Accounting' },
            { description: 'DOORDASH*ORDER', amount: '-28.43', expected: 'Meals' },
            { description: 'FEDEX SHIPPING', amount: '-45.67', expected: 'Shipping' },
            { description: 'HUBSPOT INC', amount: '-800.00', expected: 'Software - Marketing' },
            { description: 'BANK SERVICE FEE', amount: '-25.00', expected: 'Bank Fees' },
            { description: 'INTEREST EARNED', amount: '12.34', expected: 'Interest Income' },
            { description: 'GITHUB INC', amount: '-21.00', expected: 'Software - Development' },
            { description: 'STATE FARM INSURANCE', amount: '-450.00', expected: 'Insurance' },
            { description: 'AIRBNB HMQK7N', amount: '-412.00', expected: 'Travel - Lodging' },
            { description: 'CHECK DEP - INVOICE 1042', amount: '1500.00', expected: 'Revenue' },
            { description: 'WIRE TRANSFER IN - CLIENT ABC', amount: '15000.00', expected: 'Revenue' },
            { description: 'BUILDING RENT - JANUARY', amount: '-4500.00', expected: 'Rent' },
            { description: 'UNKNOWN MERCHANT 847293', amount: '-67.50', expected: 'Uncategorized' },
        ];

        async function runEvalSuite() {
            const evalBtn = document.querySelector('.eval-btn');
            const originalText = evalBtn.innerHTML;
            evalBtn.innerHTML = '<div class="spinner" style="width:14px;height:14px;"></div> Running eval...';
            evalBtn.disabled = true;

            const results = [];
            const startTime = Date.now();

            for (const testCase of EVAL_TEST_SET) {
                let result;

                if (currentEngine === 'hybrid') {
                    // Try rules first
                    result = classifyTransaction(testCase);

                    // If uncategorized or low confidence, use LLM fallback
                    if (result.needsReview || result.confidence === 'low') {
                        const fallback = document.getElementById('hybrid-fallback').value;

                        if (fallback === 'ollama' && ollamaConnected) {
                            result = await classifyWithOllama(testCase);
                            result.method = 'hybrid-ollama';
                        } else if (fallback === 'openai') {
                            const originalKey = document.getElementById('openai-key').value;
                            document.getElementById('openai-key').value = document.getElementById('hybrid-api-key').value;
                            result = await classifyWithOpenAI(testCase);
                            document.getElementById('openai-key').value = originalKey;
                            result.method = 'hybrid-openai';
                        }
                    } else {
                        result.method = 'rules';
                    }
                } else if (currentEngine === 'ollama' && ollamaConnected) {
                    result = await classifyWithOllama(testCase);
                } else if (currentEngine === 'openai') {
                    result = await classifyWithOpenAI(testCase);
                } else {
                    result = classifyTransaction(testCase);
                }

                results.push({
                    ...testCase,
                    predicted: result.category,
                    correct: result.category === testCase.expected,
                    method: result.method
                });
            }

            const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
            const correct = results.filter(r => r.correct).length;
            const accuracy = ((correct / results.length) * 100).toFixed(1);

            // Render eval results
            renderEvalResults(results, accuracy, elapsed);

            evalBtn.innerHTML = originalText;
            evalBtn.disabled = false;
        }

        function renderEvalResults(results, accuracy, elapsed) {
            const evalSection = document.querySelector('.eval-section');

            // Remove existing results
            const existingResults = evalSection.querySelector('.eval-results');
            if (existingResults) existingResults.remove();

            const accuracyClass = accuracy >= 80 ? 'good' : accuracy >= 60 ? 'medium' : 'bad';

            // Group by category for breakdown
            const byCategory = {};
            results.forEach(r => {
                if (!byCategory[r.expected]) {
                    byCategory[r.expected] = { correct: 0, total: 0 };
                }
                byCategory[r.expected].total++;
                if (r.correct) byCategory[r.expected].correct++;
            });

            const engineLabels = {
                'rules': 'âš¡ Rules',
                'hybrid': 'ðŸ”€ Hybrid',
                'ollama': 'ðŸ¦™ Ollama',
                'openai': 'ðŸ¤– OpenAI'
            };

            const html = `
                <div class="eval-results">
                    <div class="eval-header">
                        <span class="eval-title">${engineLabels[currentEngine]} Eval</span>
                        <span class="eval-accuracy ${accuracyClass}">${accuracy}%</span>
                    </div>
                    <div class="eval-breakdown">
                        ${Object.entries(byCategory).map(([cat, data]) => `
                            <div class="eval-row">
                                <span class="eval-category">${cat}</span>
                                <span class="eval-score ${data.correct === data.total ? 'correct' : ''}">${data.correct}/${data.total}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="eval-meta">
                        <span>${results.length} test cases</span>
                        <span>${elapsed}s</span>
                    </div>
                </div>
            `;

            evalSection.insertAdjacentHTML('beforeend', html);
        }

        // ===========================================
        // OPENAI CLASSIFICATION
        // ===========================================

        async function classifyWithOpenAI(transaction) {
            const apiKey = document.getElementById('openai-key').value.trim();
            const model = document.getElementById('openai-model').value;

            if (!apiKey) {
                return {
                    category: 'Uncategorized',
                    confidence: 'low',
                    method: 'error',
                    needsReview: true,
                    error: 'No API key'
                };
            }

            const categories = Object.keys(CLASSIFICATION_RULES).join(', ');

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{
                            role: 'system',
                            content: `You are a bookkeeping assistant classifying bank transactions for a small business.

Available categories: ${categories}

Respond with ONLY the category name from the list above, nothing else.`
                        }, {
                            role: 'user',
                            content: `Classify this transaction:
Description: ${transaction.description}
Amount: ${transaction.amount}`
                        }],
                        temperature: 0,
                        max_tokens: 50
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                let category = data.choices[0].message.content.trim();

                // Validate against known categories
                const validCategories = Object.keys(CLASSIFICATION_RULES);
                const matchedCategory = validCategories.find(c =>
                    category.toLowerCase() === c.toLowerCase() ||
                    category.toLowerCase().includes(c.toLowerCase())
                );

                return {
                    category: matchedCategory || category,
                    confidence: matchedCategory ? 'high' : 'medium',
                    method: 'llm'
                };
            } catch (error) {
                console.error('OpenAI classification failed:', error);
                return {
                    category: 'Uncategorized',
                    confidence: 'low',
                    method: 'error',
                    needsReview: true
                };
            }
        }

        // ===========================================
        // CSV PARSING
        // ===========================================

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

            const transactions = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const transaction = {};
                    headers.forEach((header, index) => {
                        transaction[header] = values[index];
                    });
                    transactions.push(transaction);
                }
            }

            return transactions;
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());

            return values;
        }

        // ===========================================
        // UI RENDERING
        // ===========================================

        function formatCurrency(amount) {
            const num = parseFloat(amount.replace(/[âˆ’\-\$,]/g, '-').replace('--', '-'));
            const formatted = Math.abs(num).toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD'
            });
            return num >= 0 ? formatted : `(${formatted})`;
        }

        function renderResults(transactions, classifications) {
            const container = document.getElementById('results-container');

            // Calculate stats
            const total = classifications.length;
            const highConfidence = classifications.filter(c => c.confidence === 'high').length;
            const needsReview = classifications.filter(c => c.needsReview).length;
            const usedLLM = classifications.filter(c => c.method === 'llm').length;

            // Category breakdown
            const categoryTotals = {};
            transactions.forEach((t, i) => {
                const cat = classifications[i].category;
                const amount = parseFloat(t.amount.replace(/[âˆ’\-\$,]/g, '-').replace('--', '-'));
                categoryTotals[cat] = (categoryTotals[cat] || 0) + amount;
            });

            let html = `
                <div class="stats-bar">
                    <div class="stat">
                        <div class="stat-value">${total}</div>
                        <div class="stat-label">Transactions</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value success">${Math.round(highConfidence/total*100)}%</div>
                        <div class="stat-label">High Confidence</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value warning">${needsReview}</div>
                        <div class="stat-label">Needs Review</div>
                    </div>
                    ${usedLLM > 0 ? `
                    <div class="stat">
                        <div class="stat-value info">${usedLLM}</div>
                        <div class="stat-label">LLM Classified</div>
                    </div>
                    ` : ''}
                </div>

                <div class="results-table-container" style="max-height: 500px; overflow-y: auto;">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Category</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            transactions.forEach((t, i) => {
                const c = classifications[i];
                const amount = parseFloat(t.amount.replace(/[âˆ’\-\$,]/g, '-').replace('--', '-'));
                const amountClass = amount >= 0 ? 'amount-positive' : 'amount-negative';

                html += `
                    <tr>
                        <td>${t.date}</td>
                        <td class="description-cell" title="${t.description}">${t.description}</td>
                        <td class="amount-cell ${amountClass}">${formatCurrency(t.amount)}</td>
                        <td>
                            <div class="category-cell">
                                <span class="category-badge">${c.category}</span>
                                ${c.method === 'llm' || c.method === 'hybrid-openai' || c.method === 'hybrid-ollama' ? '<span class="method-badge llm">AI</span>' : ''}
                            </div>
                        </td>
                        <td>
                            <div class="category-cell">
                                <span class="confidence-indicator confidence-${c.confidence}"></span>
                                <span>${c.confidence}</span>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <div class="export-section">
                    ${needsReview > 0 ? `
                    <button class="btn btn-primary" onclick="reclassifyWithAI()" id="ai-classify-btn">
                        Classify ${needsReview} with AI
                    </button>
                    ` : ''}
                    <button class="btn" onclick="exportCSV()">
                        Export Classified CSV
                    </button>
                </div>
            `;

            container.innerHTML = html;

            // Store for export and reclassification
            window.classifiedData = { transactions, classifications };
        }

        // ===========================================
        // RE-CLASSIFY WITH AI
        // ===========================================

        async function reclassifyWithAI() {
            const apiKey = document.getElementById('openai-key').value.trim();

            if (!apiKey) {
                alert('Please enter your OpenAI API key first.');
                document.getElementById('openai-key').focus();
                return;
            }

            if (!window.classifiedData) return;

            const { transactions, classifications } = window.classifiedData;
            const needsReviewIndices = classifications
                .map((c, i) => c.needsReview ? i : -1)
                .filter(i => i !== -1);

            // Update button to show progress
            const btn = document.getElementById('ai-classify-btn');
            const originalText = btn.textContent;

            for (let i = 0; i < needsReviewIndices.length; i++) {
                const idx = needsReviewIndices[i];
                btn.textContent = `Classifying ${i + 1}/${needsReviewIndices.length}...`;
                btn.disabled = true;

                const result = await classifyWithLLM(transactions[idx], apiKey);
                classifications[idx] = result;
            }

            // Re-render with updated classifications
            renderResults(transactions, classifications);
        }

        function showLoading(message = 'Classifying transactions...') {
            document.getElementById('results-container').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>${message}</span>
                </div>
            `;
        }

        // ===========================================
        // MAIN PROCESSING
        // ===========================================

        async function processTransactions(csvText) {
            showLoading();

            const transactions = parseCSV(csvText);
            const classifications = [];

            for (let i = 0; i < transactions.length; i++) {
                const transaction = transactions[i];
                let result;

                if (currentEngine === 'hybrid') {
                    // Try rules first
                    result = classifyTransaction(transaction);

                    // If uncategorized or low confidence, use LLM fallback
                    if (result.needsReview || result.confidence === 'low') {
                        const fallback = document.getElementById('hybrid-fallback').value;
                        showLoading(`Rules â†’ LLM fallback (${i + 1}/${transactions.length})`);

                        if (fallback === 'ollama' && ollamaConnected) {
                            result = await classifyWithOllama(transaction);
                            result.method = 'hybrid-ollama';
                        } else if (fallback === 'openai') {
                            // Use hybrid API key
                            const originalKey = document.getElementById('openai-key').value;
                            document.getElementById('openai-key').value = document.getElementById('hybrid-api-key').value;
                            result = await classifyWithOpenAI(transaction);
                            document.getElementById('openai-key').value = originalKey;
                            result.method = 'hybrid-openai';
                        }
                    } else {
                        result.method = 'rules';
                    }
                } else if (currentEngine === 'ollama' && ollamaConnected) {
                    showLoading(`Classifying with Ollama... (${i + 1}/${transactions.length})`);
                    result = await classifyWithOllama(transaction);
                } else if (currentEngine === 'openai') {
                    showLoading(`Classifying with OpenAI... (${i + 1}/${transactions.length})`);
                    result = await classifyWithOpenAI(transaction);
                } else {
                    result = classifyTransaction(transaction);
                }

                classifications.push(result);
            }

            renderResults(transactions, classifications);
        }

        // ===========================================
        // EXPORT
        // ===========================================

        function exportCSV() {
            if (!window.classifiedData) return;

            const { transactions, classifications } = window.classifiedData;

            let csv = 'date,description,amount,account,category,confidence,method\n';

            transactions.forEach((t, i) => {
                const c = classifications[i];
                csv += `${t.date},"${t.description}",${t.amount},"${t.account || ''}","${c.category}",${c.confidence},${c.method}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'classified_transactions.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ===========================================
        // EVENT HANDLERS
        // ===========================================

        // File upload
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                const reader = new FileReader();
                reader.onload = (e) => processTransactions(e.target.result);
                reader.readAsText(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => processTransactions(e.target.result);
                reader.readAsText(file);
            }
        });

        // ===========================================
        // EMBEDDED SAMPLE DATA
        // ===========================================

        const SAMPLE_SMALL_BUSINESS = `date,description,amount,reference,account
2024-01-02,STRIPE TRANSFER 240102,4250.00,,Business Checking
2024-01-03,GUSTO PAYROLL,-3200.00,PAY-001,Business Checking
2024-01-03,GUSTO PAYROLL TAX,-485.00,PAY-001,Business Checking
2024-01-05,AMZN MKTP US*2K4X7,-89.99,,Business Credit Card
2024-01-05,GOOGLE *WORKSPACE,-72.00,,Business Credit Card
2024-01-08,CHECK DEP - INVOICE 1042,1500.00,1042,Business Checking
2024-01-08,UBER TRIP 01/07,-34.50,,Business Credit Card
2024-01-09,COMCAST BUSINESS,-199.00,,Business Checking
2024-01-10,STRIPE TRANSFER 240110,6780.00,,Business Checking
2024-01-10,SLACK TECHNOLOGIES,-15.00,,Business Credit Card
2024-01-12,STAPLES DIRECT,-156.78,,Business Credit Card
2024-01-12,WF TRANSFER TO SAVINGS,-2000.00,XFER,Business Checking
2024-01-15,GUSTO PAYROLL,-3200.00,PAY-002,Business Checking
2024-01-15,GUSTO PAYROLL TAX,-485.00,PAY-002,Business Checking
2024-01-16,ZOOM.US,-149.90,,Business Credit Card
2024-01-17,ADOBE *CREATIVE CLOUD,-59.99,,Business Credit Card
2024-01-18,DELTA AIR 0062341987,-387.00,,Business Credit Card
2024-01-18,MARRIOTT CHICAGO,-289.00,,Business Credit Card
2024-01-19,UBER EATS,-42.15,,Business Credit Card
2024-01-22,STRIPE TRANSFER 240122,3920.00,,Business Checking
2024-01-22,AWS SERVICES,-234.67,,Business Credit Card
2024-01-23,LINKEDIN PREMIUM,-59.99,,Business Credit Card
2024-01-24,PG&E ELECTRIC,-342.00,,Business Checking
2024-01-25,QUICKBOOKS SUBSCRIPTION,-85.00,,Business Credit Card
2024-01-26,DOORDASH*ORDER,-28.43,,Business Credit Card
2024-01-29,STRIPE TRANSFER 240129,5100.00,,Business Checking
2024-01-29,GUSTO PAYROLL,-3200.00,PAY-003,Business Checking
2024-01-29,GUSTO PAYROLL TAX,-485.00,PAY-003,Business Checking
2024-01-30,FEDEX SHIPPING,-45.67,,Business Credit Card
2024-01-30,HUBSPOT INC,-800.00,,Business Credit Card
2024-01-31,BANK SERVICE FEE,-25.00,,Business Checking
2024-02-01,INTEREST EARNED,12.34,,Business Savings
2024-02-02,STRIPE TRANSFER 240202,4890.00,,Business Checking
2024-02-05,GITHUB INC,-21.00,,Business Credit Card
2024-02-05,NOTION LABS,-10.00,,Business Credit Card
2024-02-06,COSTCO WHSE,-523.45,,Business Credit Card
2024-02-07,STATE FARM INSURANCE,-450.00,,Business Checking
2024-02-08,FIGMA INC,-15.00,,Business Credit Card
2024-02-09,CALENDLY,-12.00,,Business Credit Card
2024-02-12,CHECK DEP - INVOICE 1089,2750.00,1089,Business Checking
2024-02-12,UBER TRIP 02/11,-28.90,,Business Credit Card
2024-02-13,AT&T WIRELESS,-185.00,,Business Checking
2024-02-14,STRIPE TRANSFER 240214,7200.00,,Business Checking
2024-02-15,GUSTO PAYROLL,-3200.00,PAY-004,Business Checking
2024-02-15,GUSTO PAYROLL TAX,-485.00,PAY-004,Business Checking
2024-02-16,AIRBNB HMQK7N,-412.00,,Business Credit Card
2024-02-19,USPS PO BOXES,-230.00,,Business Checking
2024-02-20,CANVA PTY LTD,-12.99,,Business Credit Card
2024-02-21,UNKNOWN MERCHANT 847293,-67.50,,Business Credit Card
2024-02-22,WIRE TRANSFER IN - CLIENT ABC,15000.00,WIRE-221,Business Checking
2024-02-23,CONSULTING FEE DEPOSIT,3500.00,DEP-445,Business Checking`;

        const SAMPLE_ACCOUNTING_FIRM = `date,description,amount,reference,account
2024-01-02,CLIENT RETAINER - JOHNSON MFG,5000.00,RET-2024-001,Operating Account
2024-01-03,ADP PAYROLL SERVICES,-8450.00,PAY-001,Operating Account
2024-01-03,ADP PAYROLL TAX DEPOSIT,-1856.00,PAY-001,Operating Account
2024-01-04,THOMSON REUTERS CHECKPOINT,-425.00,,Firm Credit Card
2024-01-05,AICPA MEMBERSHIP DUES,-495.00,,Firm Credit Card
2024-01-08,CCH AXCESS TAX SOFTWARE,-1200.00,,Operating Account
2024-01-09,CLIENT PMT - TAX PREP SMITH,850.00,INV-4521,Operating Account
2024-01-10,OFFICE DEPOT SUPPLIES,-234.56,,Firm Credit Card
2024-01-10,QUICKBOOKS ONLINE ACCOUNTANT,-0.00,,Firm Credit Card
2024-01-12,CAMICO E&O INSURANCE,-2400.00,,Operating Account
2024-01-15,BUILDING RENT - JANUARY,-4500.00,CHK-1001,Operating Account
2024-01-15,ADP PAYROLL SERVICES,-8450.00,PAY-002,Operating Account
2024-01-15,ADP PAYROLL TAX DEPOSIT,-1856.00,PAY-002,Operating Account
2024-01-16,BECKER CPA REVIEW - CPE,-299.00,,Firm Credit Card
2024-01-17,CLIENT PMT - BOOKKEEPING ACME,1200.00,INV-4523,Operating Account
2024-01-18,JETBLUE AIRWAYS,-342.00,,Firm Credit Card
2024-01-18,HILTON HOTELS,-198.00,,Firm Credit Card
2024-01-19,STATE CPA SOCIETY CONF,-450.00,,Firm Credit Card
2024-01-22,XERO PARTNER SUBSCRIPTION,-0.00,,Firm Credit Card
2024-01-22,CLIENT RETAINER - APEX CORP,7500.00,RET-2024-002,Operating Account
2024-01-23,DEXT (RECEIPT BANK),-50.00,,Firm Credit Card
2024-01-24,KARBON WORKFLOW SOFTWARE,-99.00,,Firm Credit Card
2024-01-25,VERIZON BUSINESS,-245.00,,Operating Account
2024-01-26,LACERTE TAX SOFTWARE,-3200.00,,Operating Account
2024-01-29,ADP PAYROLL SERVICES,-8450.00,PAY-003,Operating Account
2024-01-29,ADP PAYROLL TAX DEPOSIT,-1856.00,PAY-003,Operating Account
2024-01-30,CLIO PAYMENTS - CLIENT TRUST,2340.00,CLIO-992,Trust Account
2024-01-31,BANK ANALYSIS FEE,-35.00,,Operating Account
2024-02-01,INTEREST - TRUST ACCOUNT,8.92,,Trust Account
2024-02-02,CLIENT PMT - 1040 PREP DAVIS,425.00,INV-4530,Operating Account
2024-02-05,CALENDLY SCHEDULING,-16.00,,Firm Credit Card
2024-02-05,CANVA DESIGN,-12.99,,Firm Credit Card
2024-02-06,WOLTERS KLUWER CCH,-650.00,,Operating Account
2024-02-07,CLIENT ADVISORY FEE - TECH STARTUP,3500.00,INV-4532,Operating Account
2024-02-08,ZOOM VIDEO COMMUNICATIONS,-199.90,,Firm Credit Card
2024-02-09,MICROSOFT 365 BUSINESS,-264.00,,Firm Credit Card
2024-02-12,SAFESEND RETURNS,-75.00,,Firm Credit Card
2024-02-12,ADP PAYROLL SERVICES,-8450.00,PAY-004,Operating Account
2024-02-12,ADP PAYROLL TAX DEPOSIT,-1856.00,PAY-004,Operating Account
2024-02-14,CLIENT PMT - MONTHLY BOOKS,950.00,INV-4535,Operating Account
2024-02-15,BUILDING RENT - FEBRUARY,-4500.00,CHK-1002,Operating Account
2024-02-16,SHAREFILE CITRIX,-55.00,,Firm Credit Card
2024-02-19,CPE WEBINAR - TAX UPDATE,-79.00,,Firm Credit Card
2024-02-20,UBER TRIP CLIENT MEETING,-24.50,,Firm Credit Card
2024-02-21,PRACTICE CS SOFTWARE,-185.00,,Firm Credit Card
2024-02-22,UNKNOWN VENDOR 9X7Y2,-125.00,,Firm Credit Card
2024-02-23,REFUND - OVERPAYMENT CLIENT,-500.00,REF-001,Operating Account
2024-02-26,ADP PAYROLL SERVICES,-8450.00,PAY-005,Operating Account
2024-02-26,ADP PAYROLL TAX DEPOSIT,-1856.00,PAY-005,Operating Account
2024-02-28,CLIENT RETAINER - SMITH HOLDINGS,4000.00,RET-2024-003,Operating Account
2024-02-29,INTUIT PROCONNECT TAX,-89.00,,Firm Credit Card`;

        // Sample data buttons
        document.getElementById('load-small-business').addEventListener('click', () => {
            processTransactions(SAMPLE_SMALL_BUSINESS);
        });

        document.getElementById('load-accounting-firm').addEventListener('click', () => {
            processTransactions(SAMPLE_ACCOUNTING_FIRM);
        });
    </script>
</body>
</html>
